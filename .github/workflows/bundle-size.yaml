name: bundle size

on:
  pull_request:
    branches:
      - main

permissions:
  pull-requests: write
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  analyze-bundle:
    name: analyze bundle size
    runs-on: ubuntu-latest
    outputs:
      comment-body: ${{ steps.format_comment.outputs.body }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup
        uses: ./.github/actions/setup-node

      - name: Build PR branch
        run: pnpm bundle

      - name: Get PR branch file sizes
        run: |
          echo "PR_JS_SIZE=$(ls -l dist/umd/clera-ui.min.js | awk '{print $5}' || echo "0")" >> $GITHUB_ENV
          echo "PR_CSS_SIZE=$(ls -l dist/umd/clera-ui.min.css | awk '{print $5}' || echo "0")" >> $GITHUB_ENV

      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup
        uses: ./.github/actions/setup-node
      
      - name: Build main branch
        run: pnpm bundle
      
      - name: Get main branch file sizes
        run: |
          echo "MAIN_JS_SIZE=$(ls -l dist/umd/clera-ui.min.js | awk '{print $5}' || echo "0")" >> $GITHUB_ENV
          echo "MAIN_CSS_SIZE=$(ls -l dist/umd/clera-ui.min.css | awk '{print $5}' || echo "0")" >> $GITHUB_ENV
      
      - name: Format comment body
        id: format_comment
        run: |
          PR_JS=$((${PR_JS_SIZE:-0} / 1000))
          PR_CSS=$((${PR_CSS_SIZE:-0} / 1000))
          MAIN_JS=$((${MAIN_JS_SIZE:-0} / 1000))
          MAIN_CSS=$((${MAIN_CSS_SIZE:-0} / 1000))
          DIFF_JS=$((${PR_JS_SIZE:-0} - ${MAIN_JS_SIZE:-0}))
          DIFF_CSS=$((${PR_CSS_SIZE:-0} - ${MAIN_CSS_SIZE:-0}))
          {
            echo 'body<<EOF'
            echo '## ðŸ“¦ Bundle Size Report'
            echo ''
            echo '| File | main | PR | Change |'
            echo '| :--- | ---: | ---: | ---: |'
            echo "| \`clera-ui.min.js\` | \`$MAIN_JS kB\` | \`$PR_JS kB\` | \`$DIFF_JS B\` |"
            echo "| \`clera-ui.min.css\` | \`$MAIN_CSS kB\` | \`$PR_CSS kB\` | \`$DIFF_CSS B\` |"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
  
  post-bundle-size-comment:
    name: post bundle size comment
    runs-on: ubuntu-latest
    needs: analyze-bundle
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Post or Update Comment
        uses: ./.github/actions/post-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: bundle-size-report
          body: ${{ needs.analyze-bundle.outputs.comment-body }}