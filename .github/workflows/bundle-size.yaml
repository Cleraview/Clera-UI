name: bundle size

on:
  pull_request:
    branches:
      - main

permissions:
  pull-requests: write
  contents: read

jobs:
  analyze-bundle:
    name: analyze bundle size
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup
        uses: ./.github/actions/setup-node

      - name: Build PR branch
        run: pnpm bundle
        
      - name: Get PR branch file sizes
        run: |
          echo "PR_JS_SIZE=$(ls -l dist/umd/clera-ui.min.js | awk '{print $5}')" >> $GITHUB_ENV
          echo "PR_CSS_SIZE=$(ls -l dist/umd/clera-ui.min.css | awk '{print $5}')" >> $GITHUB_ENV
          
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          
      - name: Setup
        uses: ./.github/actions/setup-node

      - name: Build main branch
        run: pnpm bundle
        
      - name: Get main branch file sizes
        run: |
          echo "MAIN_JS_SIZE=$(ls -l dist/umd/clera-ui.min.js | awk '{print $5}')" >> $GITHUB_ENV
          echo "MAIN_CSS_SIZE=$(ls -l dist/umd/clera-ui.min.css | awk '{print $5}')" >> $GITHUB_ENV

      - name: Format comment body
        id: format_comment
        run: |
          # A helper function to format bytes
          body=$(cat <<EOF
          ## ðŸ“¦ Bundle Size Report

          | File | main | PR | Change |
          | :--- | ---: | ---: | ---: |
          | \`clera-ui.min.js\` | \`$(($MAIN_JS_SIZE / 1000)) kB\` | \`$(($PR_JS_SIZE / 1000)) kB\` | \`$(($PR_JS_SIZE - $MAIN_JS_SIZE)) B\` |
          | \`clera-ui.min.css\` | \`$(($MAIN_CSS_SIZE / 1000)) kB\` | \`$(($PR_CSS_SIZE / 1000)) kB\` | \`$(($PR_CSS_SIZE - $MAIN_CSS_SIZE)) B\` |
          EOF
          )
          echo "body=$body" >> $GITHUB_OUTPUT

      - name: Create or update comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: bundle-size-report
          body: ${{ steps.format_comment.outputs.body }}